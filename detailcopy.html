<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
        integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Noto+Sans:wght@200;500&display=swap"
        rel="stylesheet" />
    <link rel="stylesheet" href="./styles/reset.css" />
    <link rel="stylesheet" href="./styles/style.css" />
    <link rel="stylesheet" href="./styles/detail.css" />
    <title>Soovie</title>
</head>

<body>
    <nav>
        <div class="navBox">
            <h1 class="logo">
                <a href="./index.html" class="logo">Soovie</a>
            </h1>
            <form class="searchBox">
                <input class="searchInput" type="text" id="searchInput" placeholder="Search Title" />
                <button class="searchBtn" type="button" id="searchBtn">
                    <i class="fa-solid fa-magnifying-glass"></i>
                </button>
            </form>
        </div>
    </nav>

    <section class="panSection">
        <div class="l_wrapper">
            <div class="panel"></div>
        </div>
    </section>
    <section class="coSection">
        <div class="commentWrap"></div>
    </section>

    <footer>
        <div class="footerBox">
            <div class="footerLogo"><a href="./index.html"> Soovie </a></div>
            <div class="footerIconBox">
                <a href="https://github.com/choisooyoung-dev/a5_team_project" class="git"><i
                        class="fa-brands fa-github fooIc"></i></a>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
        crossorigin="anonymous"></script>

    <script>
        const options = {
            method: "GET",
            headers: {
                accept: "application/json",
                Authorization:
                    "Bearer eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiI0MDUyZDk1YTU1NzM4OTZhOWUyZTRkMDZiYmFjZDkzYSIsInN1YiI6IjY1MmY2NDQ5MGNiMzM1MTZmNjQwYjlkZSIsInNjb3BlcyI6WyJhcGlfcmVhZCJdLCJ2ZXJzaW9uIjoxfQ.V-gAyCfvw8yM8Ll7BDo1DEs9CS7vxzStmFhGra5s61g",
            },
        };

        let temp = location.href.split("?");
        // console.log(temp);
        const movieId = temp[1];
        const panel = document.querySelector(".panel");
        const commentWrap = document.querySelector(".commentWrap");

        // getIdFunc() -> drawDetailFunc() 변경
        drawDetailFunc();

        // 댓글 함수 실행
        drawCommentFunc();

        // 상세페이지 그려주는 함수
        async function drawDetailFunc() {
            const response = await fetch(
                `https://api.themoviedb.org/3/movie/${movieId}?language=ko`,
                options
            );
            // console.log(response);
            // console.log(response); // Response {type: 'cors', url: 'https://api.themoviedb.org/3/movie/top_rated?language=ko&page=1', redirected: false, status: 200, ok: true, …}
            // json(클라이언트와 서버 간의 HTTP 통신 위한 텍스트 데이터 포맷)으로 표기
            const movieData = await response.json();
            console.log(movieData);

            const movieImgSrc = movieData.backdrop_path;
            const movieTitle = movieData.title;
            const movieRating = movieData.vote_average;
            const movieReleaseDate = movieData.release_date;
            const movieOverview = movieData.overview;
            let addhtml = `
        <div class="panel-cover">
            <img
              class="panel-cover-src"
              src="https://image.tmdb.org/t/p/w1280${movieImgSrc}"
              alt=""
            />
          </div>
          <div class="panel-main">
            <div class="panel-contents" style="display: block">
              <h1 class="panel-title">${movieTitle}</h1>
              <div>
                <p>
                  ${movieOverview}
                </p>
              </div>
              <div class = "panel-btn"><h2>&blacktriangledown;</h2></div>
            </div>
          </div>
            `;
            panel.innerHTML += addhtml;
        }

        // 댓글 작업공간
        const COMMENTFORM = document.getElementById('CommentForm');
        const COMMENTLIST = document.getElementById('CommentList');
        const COMMENTTOTAL = document.querySelector("h7 > span");
        const MOVIEID = GetMovieId();

        // 페이지 로드시에 아래 함수 실행
        window.onload = function () {
            // 화면에 댓글 표시
            DisplayComments();
            // 총 댓글 수 표시
            Total();
        }

        COMMENTFORM.addEventListener("submit", WriteComment);
        COMMENTLIST.addEventListener("click", function (event) {
            if (event.target.classList.contains("Del_btn")) {
                DeleteComment();
            }
        });
        COMMENTLIST.addEventListener("click", function (event) {
            if (event.target.classList.contains("Edit_btn")) {
                EditComment();
            }
        });

        // 댓글 그려주는 함수
        async function drawCommentFunc() {
            // localStorage part

            // 댓글
            let commentAddHtml = `
        <div class="commentsWrap">
          <div class="comments">
            <div class="movieId">${movieId}</div>
            <div class="commentCount">
              <i class="fa-solid fa-comment"></i><h7><span></span>(리뷰수)</h7>
            </div>

            <div id="CommentList" class="commentBox">
              
            </div>

            <div class="commentInputBox">
              <form id="CommentForm">
                <p class="commentUser">
                    <input
                    type="text"
                    placeholder="이름을 입력하세요"
                    id="username"
                    />
                </p>
                <p class='passwordUser'>
                    <input
                    type="password"
                    placeholder="비밀번호를 입력하세요"
                    id="password"
                    />
                </p>
                <p class="comment">
                    <input placeholder="리뷰를 작성해주세요" id="comment" />
                </p>
                <button class="btn btn-warning coSubmitBtn" type="submit">
                    확인
                </button>
                </form>
            </div>
          </div>
       </div>
        `;

            commentWrap.innerHTML += commentAddHtml;
        }

        // 댓글 작성하기
        function WriteComment(event) {
            event.preventDefault();

            let username = document.getElementById('username').value;
            let password = document.getElementById('password').value;
            let comment = document.getElementById('comment').value;

            // 작성일자
            let today = new Date();
            let year = today.getFullYear();
            let month = today.getMonth() + 1;
            let date = today.getDate();
            let dateWritten = (year + '-' + month + '-' + date);

            // 빈 값 데이터 유효성검사
            if (username === "" || password === "" || comment === "") {
                alert("이름, 비밀번호, 리뷰중 빈곳이 있습니다.");
                return;
            }

            let comments = GetCommentFromMovieID(MOVIEID);
            comments.push({ username, password, comment, dateWritten });
            SetCommentFromMovieID(MOVIEID, comments);
            // 입력내용 비우기
            COMMENTFORM.reset();
            DisplayComments();
            Total();

        }

        // 댓글 삭제하기
        function DeleteComment() {
            let comments = GetCommentFromMovieID(MOVIEID);

            // 유저로부터 입력값을 받을수 있고 문구를 띄운다.
            let password = prompt("비밀번호를 입력해주세요.");

            // 비밀번호 일치여부 체크
            let checkcomment = comments.find(comments => comments.password === password);

            if (checkcomment) {
                // 비밀번호가 일치하는 댓글을 제외시키고 업데이트된 댓글 목록 생성
                let updatecomment = comments.filter(comments => comments !== checkcomment);
                SetCommentFromMovieID(MOVIEID, updatecomment);
                DisplayComments();
                Total();
            }
            else {
                alert("비밀번호를 확인해주세요.");
            }
        }

        // 댓글 수정하기
        function EditComment() {
            let comments = GetCommentFromMovieID(MOVIEID);

            // 유저로부터 입력값을 받을수 있고 문구를 띄운다.
            let password = prompt("비밀번호를 입력해주세요.");

            // 비밀번호 일치여부 체크 및 해당 댓글 식별
            let checkcomment = comments.find(comments => comments.password === password);

            if (checkcomment) {
                // 해당 댓글 인덱스값 
                let index = comments.indexOf(checkcomment);

                let editcomment = prompt("새 댓글 내용을 입력해주세요.");
                // 빈값 데이터 유효성 검사
                if (editcomment === "") {
                    alert("공백을 입력할 수 없습니다.");
                    return;
                }
                //  댓글 내용 수정
                comments[index].comment = editcomment;

                SetCommentFromMovieID(MOVIEID, comments);
                DisplayComments();
                Total();
            }
            else {
                alert("비밀번호를 확인해주세요.");
            }
        }

        // 댓글 표시하기
        function DisplayComments() {
            COMMENTLIST.innerHTML = "";
            let comments = GetCommentFromMovieID(MOVIEID);

            comments.forEach(element => {
                let comment_element = document.createElement('div');
                comment_element.innerHTML = `
                <p class="commentUser">${element.username}</p>
                <p class="comment">${element.comment}</p>
                <p class="commentDate"> 작성일자 : ${element.dateWritten} </p>
                <button id="Del_btn" class="btn btn-warning Del_btn" type="button">삭제</button>
                <button id="Edit_btn" class="btn btn-warning Edit_btn" type="button">수정</button>
                `;

                COMMENTLIST.appendChild(comment_element);
            });
        }

        // 총 댓글 수 표시하기
        function Total() {
            let comments = GetCommentFromMovieID(MOVIEID);
            COMMENTTOTAL.innerText = comments.length;
        }

        // 영화 id 추출하기
        function GetMovieId() {
            let temp = location.href.split("?");
            let movieId = temp[1];
            return movieId;
        }

        // 영화 id를 기반으로 해당 영화 댓글 가져오기
        function GetCommentFromMovieID(MOVIEID) {
            // 해당하는 영화 localStorage에 빈배열 생성
            if (localStorage.getItem(`${MOVIEID}`) === null) {
                localStorage.setItem(`${MOVIEID}`, JSON.stringify([]));
            }

            return JSON.parse(localStorage.getItem(`${MOVIEID}`));
        }

        // 해당 영화id localStorage에 댓글 저장하기
        function SetCommentFromMovieID(MOVIEID, comments) {
            localStorage.setItem(`${MOVIEID}`, JSON.stringify(comments));
        }

    </script>
</body>

</html>